\section{Beispiel für Sonderbehandlung der Curry-Bindungsconstraints hinsichtlich des Wrappings}
\label{anhangD}

Das folgende Beispiel zeigt die in Kapitel 4.3.3 angesprochene Problematik hinsichtlich des Wrappings der Curry-Bindungsconstraints noch einmal auf:
\begin{lstlisting}[language=Haskell,caption=Beispiel für Problem bei Kombination von Curry-Bindungsconstraints und FD-Constraints]
l =:= genVars 2 & domain l 1 2 & labeling l where l free
\end{lstlisting}
Wie man sieht, wird in diesem Beispiel ein Curry-Gleichheitsconstraint über der freien Variable \lstinline|l| kombiniert mit FD-Constraints über der gleichen freien Variable. Die externe Implementierung von \lstinline|domain| und \lstinline|labeling| sorgt dafür, dass die \lstinline|Choice|, durch die \lstinline|l| intern repräsentiert wird, in eine \lstinline|NarrowedChoice| umgewandelt wird. Der Suchraum dieser \lstinline|NarrowedChoice| besteht aus allen möglichen Listen, die \lstinline|l| annehmen könnte, also die leere Liste, die Liste mit einer freien Integervariablen, mit zwei freien Integervariablen usw.
\\
Löst man das durch \lstinline|l =:= genVars 2| erzeugte Bindungsconstraint für die Variable \lstinline|l|. So legt die zugehörige Bindungsentscheidung fest, dass in den \lstinline|NarrowedChoices| nur die Pfade weiter ausgewertet werden sollen, in denen \lstinline|l| eine zweielementige Liste ist.
\\
Die folgenden drei Abbildungen von KiCS2-Auswertungsbäumen für den obigen Beispielausdruck verdeutlichen die Problematik: Abbildung \textcolor{red}{$<$hier endgültige Abbildungsnr$>$} zeigt den KiCS2-Auswertungsbaum \textbf{bevor} durch Aufruf von \lstinline|searchWrappedCs| alle "'eingepackten"' Constraints eingesammelt werden. 
\\
Abbildung \textcolor{red}{$<$hier endgültige Abbildungsnr$>$} stellt den Auswertungsbaum nach dem Aufruf von \lstinline|searchWrappedCs| dar, das heißt alle \lstinline|WrappedConstraint|s in einem Pfad des Baumes wurden in einem \lstinline|Guard|-Ausdruck gesammelt. In diesem Fall sind auch die Curry-Bindungsconstraints in einem Constraint-Wrapper "'eingepackt"'.
\\
In Abbildung \textcolor{red}{$<$hier endgültige Abbildungsnr$>$} wird der Auswertungsbaum ebenfalls nach dem Aufruf von \lstinline|searchWrappedCs| dargestellt. Die Curry-Bindungsconstraints werden dieses Mal allerdings gesondert behandelt und nicht in den Constraint-Wrapper "'gepackt"'.
\\
Alle drei Abbildungen sind stark vereinfacht: Das für den Ausdruck \lstinline|l =:= genVars 2| erzeugte Bindungsconstraint wird durch \lstinline|CBC_l| (für \textbf{C}urry-\textbf{B}indung\textbf{c}onstraint für \textbf{l}) repräsentiert. Auch die FD-Constraints werden verkürzt dargestellt: So steht \lstinline|DomainN| für ein passendes \lstinline|FDDomain|-Constraint über einer \lstinline|N|-stelligen Liste. Das heißt, \lstinline|Domain0| ist äquivalent zu dem Constraint-Term \lstinline|FDDomain [] (Const 1) (Const 2)|, \lstinline|Domain1| zu dem \lstinline|FDConstraint|-Konstruktorterm \lstinline|FDDomain [FDVar 1] (Const 1) (Const 2)| usw. Für \lstinline|LabelN| gilt das gleiche: Hier entsprechen die verkürzten Formen passenden \lstinline|FDLabeling|-Constraints mit der entsprechenden Anzahl von Listenelementen.
Abgesehen von dem Curry-Bindungsconstraint sind alle anderen Constraints in einem Constraint-Wrapper "'eingepackt"'. Nur in Abbildung 7 ist das Curry-Bindungsconstraint auch in einem solchen Wrapper "'verpackt"'.
\newpage
\begin{figure}[!h]
\begin{center}
\begin{tikzpicture}
\node (n1) at (5,6.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Guard <CBC_l>|};
\node (n2) at (5,5.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Narrowed1|};
\node (n3) at (1,4.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Guard [Domain0]|};
\node (n4) at (4,4.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Guard [Domain1]|};
\node (n5) at (7,4.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Guard [Domain2]|};
\node (n6) at (10.5,4.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|...|};
\node (n7) at (1,3.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Narrowed2|};
\node (n8) at (4,3.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Narrowed3|};
\node (n9) at (7,3.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Narrowed4|};
\node (n10) at (4,2.5) {};
\node (n11) at (7,2.5) {};
\node (n12) at (0,1.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Guard [Label0]|};
\node (n13) at (2.5,1.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Guard [Label1]|};
\node (n14) at (4,1.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|...|};
\node (n15) at (0,0.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Val Success|};
\node (n16) at (2.5,0.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Val Success|};
\draw (n1) -- (n2);
\draw (n2) -- (n3);
\draw (n2) -- (n4);
\draw (n2) -- (n5);
\draw (n2) -- (n6);
\draw (n3) -- (n7);
\draw (n4) -- (n8);
\draw (n5) -- (n9);
\draw (n7) -- (n12);
\draw (n7) -- (n13);
\draw (n8) -- (n10);
\draw (n9) -- (n11);
\draw (n12) -- (n15);
\draw (n13) -- (n16);
\end{tikzpicture}
\end{center}
\caption{Ausschnitt des Suchbaums \textbf{vor} Aufruf von \lstinline|searchWrappedCs|}
\end{figure}
\begin{figure}[!h]
\begin{center}
\begin{tikzpicture}
\node (n1) at (5,5.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Narrowed1|};
\node (n2) at (1,4.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Narrowed2|};
\node (n3) at (4,4.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Narrowed3|};
\node (n4) at (7,4.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Narrowed4|};
\node (n5) at (10,4.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|...|};
\node (n6) at (4,3.5) {};
\node (n7) at (7,3.5) {};
\node (n8) at (0,2.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Guard [CBC_l, Domain0, Label0]|};
\node (n9) at (5.5,2.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Guard [CBC_l, Domain0, Label1]|};
\node (n10) at (9,2.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|...|};
\node (n11) at (0,1.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Val Success|};
\node (n12) at (5.5,1.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Val Success|};
\draw (n1) -- (n2);
\draw (n1) -- (n3);
\draw (n1) -- (n4);
\draw (n1) -- (n5);
\draw (n3) -- (n6);
\draw (n4) -- (n7);
\draw (n2) -- (n8);
\draw (n2) -- (n9);
\draw (n8) -- (n11);
\draw (n9) -- (n12);
\end{tikzpicture}
\end{center}
\caption{Ausschnitt des Suchbaums \textbf{nach} Aufruf von \lstinline|searchWrappedCs| (Curry-Bindungsconstraints in Wrapper)}
\end{figure}
\begin{figure}[!h]
\begin{center}
\begin{tikzpicture}
\node (n1) at (5,5.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Guard <CBC_l>|};
\node (n2) at (5,4.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Narrowed1|};
\node (n3) at (1,3.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Narrowed2|};
\node (n4) at (4,3.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Narrowed3|};
\node (n5) at (7,3.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Narrowed4|};
\node (n6) at (10,3.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|...|};
\node (n7) at (4,2.5) {};
\node (n8) at (7,2.5) {};
\node (n9) at (0,1.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Guard [Domain0, Label0]|};
\node (n10) at (4,1.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Guard [Domain0, Label1]|};
\node (n11) at (7,1.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|...|};
\node (n12) at (0,0.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Val Success|};
\node (n13) at (4,0.5) {\lstinline[basicstyle=\footnotesize\ttfamily]|Val Success|};
\draw (n1) -- (n2);
\draw (n2) -- (n3);
\draw (n2) -- (n4);
\draw (n2) -- (n5);
\draw (n2) -- (n6);
\draw (n4) -- (n7);
\draw (n5) -- (n8);
\draw (n3) -- (n9);
\draw (n3) -- (n10);
\draw (n9) -- (n12);
\draw (n10) -- (n13);
%\draw (n9) -- (n11);
%\draw (n12) -- (n15);
%\draw (n13) -- (n16);
\end{tikzpicture}
\end{center}
\caption{Ausschnitt des Suchbaums \textbf{nach} Aufruf von \lstinline|searchWrappedCs| (separate Behandlung von Curry-Bindungsconstraints)}
\end{figure}
Der Vergleich der Abbildungen \textcolor{red}{$<$hier endgültige Abbildungsnr$>$} zeigt das Problem: Behandelt man alle Constraint-Typen gleich, so werden die Curry-Bindungsconstraints ebenfalls eingesammelt. Dadurch werden sie in einen \lstinline|Guard|-Knoten "'unterhalb"' der \lstinline|NarrowedChoice|-Knoten verschoben. Selbst wenn man nun zuerst die Curry-Bindungsconstraints löst, wird die Auswertung nicht mehr terminieren, da die \lstinline|NarrowedChoice|-Knoten zu diesem Zeitpunkt bereits ausgewertet wurden. Es können also nicht mehr die "'richtigen"' Pfade der \lstinline|NarrowedChoice|s für die Auswertung ausgewählt werden. Stattdessen werden alle Pfade nacheinander ausgewertet.
\\
Verhindern lässt sich dies nur, wenn man die Curry-Bindungsconstraints gesondert behandelt und nicht mit den anderen Constraints einsammelt, denn in diesem Fall bleiben die \lstinline|Guard|-Knoten mit Bindungsconstraints "'oberhalb"' der \lstinline|NarrowedChoice|-Knoten im Auswertungsbaum (vergleiche Abbildung \textcolor{red}{$<$hier endgültige Abbildungsnr$>$}).
