# directory containing the repository library files:
CURRYLIBSDIR=$(ROOT)/lib-trunk
CURRYLIBSSRCDIR=$(CURRYLIBSDIR)/src

MODULE_FOLDERS :=$(shell cd $(CURRYLIBSSRCDIR) && find * -type d)
CURRY_FILES    :=$(shell cd $(CURRYLIBSSRCDIR) && find * -name "*.curry")
GHC_FILES      :=$(shell cd $(CURRYLIBSSRCDIR) && find * -name "*.kics2")
GHC_CURRY_FILES:=$(addsuffix .curry, $(basename $(GHC_FILES)))
CURRYONLY_FILES =$(filter-out $(GHC_CURRY_FILES), $(CURRY_FILES))

##########################################################################
# Install the library sources into the Curry system library directory:
.PHONY: install
install: $(MODULE_FOLDERS) $(CURRYONLY_FILES) $(GHC_CURRY_FILES) $(LIBDIR)/Makefile $(LIBDIR)/VERSION $(LIBDIR)/kics2-libraries.cabal

$(MODULE_FOLDERS): %: $(CURRYLIBSSRCDIR)/%
	mkdir -p $@

$(CURRYONLY_FILES): %.curry: $(CURRYLIBSSRCDIR)/%.curry
	cp $< $@

$(GHC_FILES): %.kics2: $(CURRYLIBSSRCDIR)/%.kics2
	cp $< $@

$(GHC_CURRY_FILES): %.curry: $(CURRYLIBSSRCDIR)/%.curry %.kics2
	cp $< $@

$(LIBDIR)/Makefile: $(ROOT)/Makefile_lib
	cp $< $@

$(LIBDIR)/VERSION: $(CURRYLIBSDIR)/VERSION
	cp $< $@

# Generates the Cabal file for the libraries
# TODO: Update to build the entiry lib, instead of just the Prelude
$(LIBDIR)/kics2-libraries.cabal:
	@echo "Name:           kics2-libraries"                                        > $@
	@echo "Version:        $(VERSION)"                                            >> $@
	@echo "Description:    The standard libraries for KiCS2"                      >> $@
	@echo "License:        OtherLicense"                                          >> $@
	@echo "Author:         The KiCS2 Team"                                        >> $@
	@echo "Maintainer:     kics2@curry-lang.org"                                  >> $@
	@echo "Build-Type:     Simple"                                                >> $@
	@echo "Cabal-Version:  >= 1.9.2"                                              >> $@
	@echo ""                                                                      >> $@
	@echo "Library"                                                               >> $@
	@echo "  Build-Depends: kics2-runtime,$(subst $(SPACE),$(COMMA),$(LIBDEPS))"  >> $@
	@echo "  if os(windows)"                                                      >> $@
	@echo "    Build-Depends: Win32"                                              >> $@
	@echo "  else"                                                                >> $@
	@echo "    Build-Depends: unix"                                               >> $@
	@echo "  Exposed-modules: Curry_Prelude"                                      >> $@
	@echo "  hs-source-dirs: ./.curry/kics2"                                      >> $@
